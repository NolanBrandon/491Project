name: CI - Auto Test and Bug Tracking

on:
  push:
    branches:
      - main
      - SCRUM-**
  pull_request:
    branches:
      - main
      - SCRUM-**

permissions:
  contents: write   # allows pushing docs for same-repo branches
  pull-requests: read

jobs:
  test-and-track:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt || pip install pytest

      - name: Run tests
        run: |
          cd backend
          pytest --maxfail=3 --disable-warnings -q --junitxml=test_results.xml
          cd ..

      - name: Generate test and bug tracking reports
        run: |
          mkdir -p docs
          echo "## ✅ Test Results - $(date)" > docs/test_results.md
          echo "" >> docs/test_results.md
          pytest --maxfail=3 --disable-warnings -q --tb=short >> docs/test_results.md || true
          echo "" >> docs/test_results.md
          echo "## 🐞 Bug Tracking" > docs/bugs.md
          echo "- Automated bug scan completed $(date)" >> docs/bugs.md

      # --- Push step (only for same-repo branches or main) ---
      - name: Commit and push test docs
        if: >
          (github.event_name == 'push') ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        run: |
          echo "Attempting to push updated test docs..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/test_results.md docs/bugs.md
          git commit -m "Update test results and bug tracking from CI run" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.head_ref || github.ref_name }}

      # --- Skip step (for forks, prevents red ❌) ---
      - name: Skip push for forked PRs
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name != github.repository
        run: |
          echo "Skipping git push for forked PR – forks don’t have write access to this repo."
